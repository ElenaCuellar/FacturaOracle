--------------------------------------------------------
-- Archivo creado  - martes-noviembre-08-2016   
--------------------------------------------------------
--------------------------------------------------------
--  DDL for Table ARTICULOS
--------------------------------------------------------

  CREATE TABLE "ACCESODATOS"."ARTICULOS" 
   (	"REFERENCIA" VARCHAR2(13 BYTE), 
	"DESCRIPCION" VARCHAR2(20 BYTE), 
	"STOCK" NUMBER(*,0), 
	"PRECIO" NUMBER(10,2)
   ) SEGMENT CREATION IMMEDIATE 
  PCTFREE 10 PCTUSED 40 INITRANS 1 MAXTRANS 255 NOCOMPRESS LOGGING
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1 BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "SYSTEM" ;
--------------------------------------------------------
--  DDL for Table CLIENTES
--------------------------------------------------------

  CREATE TABLE "ACCESODATOS"."CLIENTES" 
   (	"CODIGO" NUMBER(*,0), 
	"DNI" VARCHAR2(10 BYTE), 
	"NOMBRE" VARCHAR2(50 BYTE), 
	"FECNAC" DATE
   ) SEGMENT CREATION IMMEDIATE 
  PCTFREE 10 PCTUSED 40 INITRANS 1 MAXTRANS 255 NOCOMPRESS LOGGING
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1 BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "SYSTEM" ;
--------------------------------------------------------
--  DDL for Table FACTURAS
--------------------------------------------------------

  CREATE TABLE "ACCESODATOS"."FACTURAS" 
   (	"NFACTURA" NUMBER(*,0), 
	"FECFACTURA" DATE, 
	"CODCLIENTE" NUMBER(30,0), 
	"TOTAL" NUMBER(12,2), 
	"PAGADA" VARCHAR2(1 BYTE)
   ) SEGMENT CREATION IMMEDIATE 
  PCTFREE 10 PCTUSED 40 INITRANS 1 MAXTRANS 255 NOCOMPRESS LOGGING
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1 BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "SYSTEM" ;
--------------------------------------------------------
--  DDL for Table LINFACTURAS
--------------------------------------------------------

  CREATE TABLE "ACCESODATOS"."LINFACTURAS" 
   (	"ID" NUMBER(*,0), 
	"NFACTURA" NUMBER(*,0), 
	"REFERENCIA" VARCHAR2(13 BYTE), 
	"CANTIDAD" NUMBER(*,0), 
	"DESCUENTO" NUMBER(10,2)
   ) SEGMENT CREATION IMMEDIATE 
  PCTFREE 10 PCTUSED 40 INITRANS 1 MAXTRANS 255 NOCOMPRESS LOGGING
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1 BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "SYSTEM" ;
REM INSERTING into ACCESODATOS.ARTICULOS
SET DEFINE OFF;
Insert into ACCESODATOS.ARTICULOS (REFERENCIA,DESCRIPCION,STOCK,PRECIO) values ('1AQ5','Pendrive 20Gb','20','10');
Insert into ACCESODATOS.ARTICULOS (REFERENCIA,DESCRIPCION,STOCK,PRECIO) values ('5TR9','Impresora 3D','100','900');
Insert into ACCESODATOS.ARTICULOS (REFERENCIA,DESCRIPCION,STOCK,PRECIO) values ('8YN1','Raton optico','200','5');
Insert into ACCESODATOS.ARTICULOS (REFERENCIA,DESCRIPCION,STOCK,PRECIO) values ('4BO6','Portatil Lenovo','50','850');
REM INSERTING into ACCESODATOS.CLIENTES
SET DEFINE OFF;
Insert into ACCESODATOS.CLIENTES (CODIGO,DNI,NOMBRE,FECNAC) values ('1','23650958g','Antonio',to_date('12-03-92','DD-MM-YY'));
Insert into ACCESODATOS.CLIENTES (CODIGO,DNI,NOMBRE,FECNAC) values ('2','12436509y','Maria',to_date('17-08-00','DD-MM-YY'));
Insert into ACCESODATOS.CLIENTES (CODIGO,DNI,NOMBRE,FECNAC) values ('3','76091233p','Victor',to_date('29-10-81','DD-MM-YY'));
REM INSERTING into ACCESODATOS.FACTURAS
SET DEFINE OFF;
Insert into ACCESODATOS.FACTURAS (NFACTURA,FECFACTURA,CODCLIENTE,TOTAL,PAGADA) values ('1',to_date('30-12-89','DD-MM-YY'),'1','90','s');
Insert into ACCESODATOS.FACTURAS (NFACTURA,FECFACTURA,CODCLIENTE,TOTAL,PAGADA) values ('2',to_date('24-04-15','DD-MM-YY'),'3','2422,5','n');
Insert into ACCESODATOS.FACTURAS (NFACTURA,FECFACTURA,CODCLIENTE,TOTAL,PAGADA) values ('3',to_date('12-02-14','DD-MM-YY'),'2','24,6','s');
Insert into ACCESODATOS.FACTURAS (NFACTURA,FECFACTURA,CODCLIENTE,TOTAL,PAGADA) values ('4',to_date('05-07-16','DD-MM-YY'),'3','3453,5','s');
Insert into ACCESODATOS.FACTURAS (NFACTURA,FECFACTURA,CODCLIENTE,TOTAL,PAGADA) values ('5',to_date('01-09-16','DD-MM-YY'),'1','2695','n');
Insert into ACCESODATOS.FACTURAS (NFACTURA,FECFACTURA,CODCLIENTE,TOTAL,PAGADA) values ('6',to_date('17-10-16','DD-MM-YY'),'2','13','n');
Insert into ACCESODATOS.FACTURAS (NFACTURA,FECFACTURA,CODCLIENTE,TOTAL,PAGADA) values ('7',null,null,'0',null);
REM INSERTING into ACCESODATOS.LINFACTURAS
SET DEFINE OFF;
Insert into ACCESODATOS.LINFACTURAS (ID,NFACTURA,REFERENCIA,CANTIDAD,DESCUENTO) values ('1','1','8YN1','4','0');
Insert into ACCESODATOS.LINFACTURAS (ID,NFACTURA,REFERENCIA,CANTIDAD,DESCUENTO) values ('2','1','1AQ5','7','0');
Insert into ACCESODATOS.LINFACTURAS (ID,NFACTURA,REFERENCIA,CANTIDAD,DESCUENTO) values ('3','2','4BO6','3','5');
Insert into ACCESODATOS.LINFACTURAS (ID,NFACTURA,REFERENCIA,CANTIDAD,DESCUENTO) values ('4','3','1AQ5','2','2');
Insert into ACCESODATOS.LINFACTURAS (ID,NFACTURA,REFERENCIA,CANTIDAD,DESCUENTO) values ('5','3','8YN1','1','0');
Insert into ACCESODATOS.LINFACTURAS (ID,NFACTURA,REFERENCIA,CANTIDAD,DESCUENTO) values ('6','4','5TR9','3','4');
Insert into ACCESODATOS.LINFACTURAS (ID,NFACTURA,REFERENCIA,CANTIDAD,DESCUENTO) values ('7','4','1AQ5','2','0');
Insert into ACCESODATOS.LINFACTURAS (ID,NFACTURA,REFERENCIA,CANTIDAD,DESCUENTO) values ('8','4','4BO6','1','1');
Insert into ACCESODATOS.LINFACTURAS (ID,NFACTURA,REFERENCIA,CANTIDAD,DESCUENTO) values ('9','5','5TR9','3','5');
Insert into ACCESODATOS.LINFACTURAS (ID,NFACTURA,REFERENCIA,CANTIDAD,DESCUENTO) values ('10','6','8YN1','2','6');
Insert into ACCESODATOS.LINFACTURAS (ID,NFACTURA,REFERENCIA,CANTIDAD,DESCUENTO) values ('11','6','1AQ5','1','1');
--------------------------------------------------------
--  DDL for Index SYS_C008848
--------------------------------------------------------

  CREATE UNIQUE INDEX "ACCESODATOS"."SYS_C008848" ON "ACCESODATOS"."ARTICULOS" ("REFERENCIA") 
  PCTFREE 10 INITRANS 2 MAXTRANS 255 COMPUTE STATISTICS 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1 BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "SYSTEM" ;
--------------------------------------------------------
--  DDL for Index SYS_C008849
--------------------------------------------------------

  CREATE UNIQUE INDEX "ACCESODATOS"."SYS_C008849" ON "ACCESODATOS"."CLIENTES" ("CODIGO") 
  PCTFREE 10 INITRANS 2 MAXTRANS 255 COMPUTE STATISTICS 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1 BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "SYSTEM" ;
--------------------------------------------------------
--  DDL for Index SYS_C008850
--------------------------------------------------------

  CREATE UNIQUE INDEX "ACCESODATOS"."SYS_C008850" ON "ACCESODATOS"."FACTURAS" ("NFACTURA") 
  PCTFREE 10 INITRANS 2 MAXTRANS 255 COMPUTE STATISTICS 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1 BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "SYSTEM" ;
--------------------------------------------------------
--  DDL for Index SYS_C008851
--------------------------------------------------------

  CREATE UNIQUE INDEX "ACCESODATOS"."SYS_C008851" ON "ACCESODATOS"."LINFACTURAS" ("ID") 
  PCTFREE 10 INITRANS 2 MAXTRANS 255 COMPUTE STATISTICS 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1 BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "SYSTEM" ;
--------------------------------------------------------
--  Constraints for Table ARTICULOS
--------------------------------------------------------

  ALTER TABLE "ACCESODATOS"."ARTICULOS" ADD PRIMARY KEY ("REFERENCIA")
  USING INDEX PCTFREE 10 INITRANS 2 MAXTRANS 255 COMPUTE STATISTICS 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1 BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "SYSTEM"  ENABLE;
--------------------------------------------------------
--  Constraints for Table CLIENTES
--------------------------------------------------------

  ALTER TABLE "ACCESODATOS"."CLIENTES" ADD PRIMARY KEY ("CODIGO")
  USING INDEX PCTFREE 10 INITRANS 2 MAXTRANS 255 COMPUTE STATISTICS 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1 BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "SYSTEM"  ENABLE;
--------------------------------------------------------
--  Constraints for Table FACTURAS
--------------------------------------------------------

  ALTER TABLE "ACCESODATOS"."FACTURAS" MODIFY ("NFACTURA" NOT NULL ENABLE);
  ALTER TABLE "ACCESODATOS"."FACTURAS" ADD PRIMARY KEY ("NFACTURA")
  USING INDEX PCTFREE 10 INITRANS 2 MAXTRANS 255 COMPUTE STATISTICS 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1 BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "SYSTEM"  ENABLE;
--------------------------------------------------------
--  Constraints for Table LINFACTURAS
--------------------------------------------------------

  ALTER TABLE "ACCESODATOS"."LINFACTURAS" ADD PRIMARY KEY ("ID")
  USING INDEX PCTFREE 10 INITRANS 2 MAXTRANS 255 COMPUTE STATISTICS 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1 BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "SYSTEM"  ENABLE;
--------------------------------------------------------
--  DDL for Procedure SP_TOTAL_FACTURA
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "ACCESODATOS"."SP_TOTAL_FACTURA" (xnfac FACTURAS.nFactura%type,
xTotal OUT FACTURAS.Total%type) AS
  nr NUMBER;
  BEGIN
    SELECT COUNT(*) INTO nr FROM Facturas WHERE nfactura = xnfac;
    IF (nr = 0) THEN --En caso de meter una factura que no exista
      xTotal := -1;
      RETURN;
    ELSE
      SELECT COALESCE(SUM(cantidad*precio*(1-(descuento/100))),0) INTO xTotal FROM LinFacturas l INNER JOIN Articulos a 
      ON l.referencia=a.referencia WHERE l.nfactura=xnfac;
    END IF;
    IF (xTotal != -1) THEN
      UPDATE Facturas SET Total=xTotal WHERE nFactura= xnfac;
    END IF;
  END sp_Total_Factura;

/
